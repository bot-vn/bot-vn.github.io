<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Countdown Timer</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
    #countdown { font-size: 48px; font-weight: bold; color: #333; }
    #info { margin-top: 20px; font-size: 18px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Countdown Timer</h1>
  <div id="countdown">00:00s</div>
  <div id="info"></div>

  <script>
    // Hàm base62 tương thích với 12Help.js
    const BASE62_CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    const base62 = {
      decode: function(encoded) {
        let result = '';
        for (let i = 0; i < encoded.length; i++) {
          const value = BASE62_CHARS.indexOf(encoded[i]);
          if (value === -1) {
            throw new Error('Invalid base62 character');
          }
          // Ánh xạ ngược charCode % 62 = value
          let charCode = value;
          // Tìm charCode nhỏ nhất trong phạm vi ASCII (0-127) phù hợp
          while (charCode < 128 && charCode % 62 !== value) {
            charCode += 62;
          }
          if (charCode >= 128) {
            // Nếu không tìm thấy, thử phạm vi Unicode cơ bản
            charCode = value + 62; // Giả sử ký tự đơn giản
          }
          result += String.fromCharCode(charCode);
        }
        return result;
      }
    };

    // Lấy tham số từ URL
    const queryString = window.location.search.slice(1); // Bỏ dấu ?
    let params = {};
    try {
      const decoded = base62.decode(queryString);
      console.log('Decoded string:', decoded); // Log để debug
      params = JSON.parse(decoded);
      console.log('Parsed params:', params); // Log để debug
    } catch (e) {
      console.error('Lỗi giải mã params:', e);
      document.getElementById('countdown').innerHTML = '<span class="error">Lỗi: Dữ liệu không hợp lệ</span>';
      return;
    }

    // Hiển thị thông tin rương
    document.getElementById('info').innerHTML = `
      User: ${params.user || 'N/A'}<br>
      Box: ${params.box || 0}/${params.divide || 0}<br>
      Viewers: ${params.viewers || 0}<br>
      Country: ${params.country || 'N/A'}<br>
      Created: ${params.createAt ? new Date(parseInt(params.createAt)).toLocaleString() : 'N/A'}
    `;

    // Countdown logic
    const endTime = parseInt(params.end);
    if (!endTime || isNaN(endTime) || endTime <= 0) {
      console.error('Lỗi: endTime không hợp lệ:', params.end);
      document.getElementById('countdown').innerHTML = '<span class="error">Lỗi: Thời gian không hợp lệ</span>';
      return;
    }

    // Kiểm tra nếu thời gian đã hết hạn ngay từ đầu
    const now = Date.now();
    if (endTime <= now) {
      console.warn('Thời gian đã hết hạn:', endTime, now);
      document.getElementById('countdown').innerHTML = 'EXPIRED';
      return;
    }

    const x = setInterval(() => {
      const now = Date.now();
      const distance = endTime - now;

      if (distance < 0) {
        clearInterval(x);
        document.getElementById('countdown').innerHTML = 'EXPIRED';
      } else {
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        document.getElementById('countdown').innerHTML = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}s`;
      }
    }, 1000);
  </script>
</body>
</html>
